---
import { Icon } from "astro-icon/components";
import moment from "moment-timezone";
const { time, name, img, description, twitch, youtube } = Astro.props;

function formatDateToRFC3339(dateStr) {
    const date = moment(dateStr);
    if (!date.isValid()) {
        console.error("Invalid date: " + dateStr);
        return "";
    }
    return date.utc().format("YYYYMMDDTHHmmss") + "Z";
}

const startTime = formatDateToRFC3339(time);
const endTime = formatDateToRFC3339(moment(time).add(1, 'hours'));

const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(name)}&dates=${startTime}/${endTime}&details=${encodeURIComponent(description)}&sf=true&output=xml`;
---

<div class="bg-bunker-900 rounded-xl shadow-md overflow-hidden">
    <div class="md:flex">
        <div class="events-img md:shrink-0">
            <img class="h-48 w-full object-cover md:h-full md:w-[22rem]" src={img} alt={name} loading="lazy">
        </div>
        <div class="p-4 md:min-h-60">
            <h2 class="text-2xl pb-2" id={name}>{name}</h2>
            <div>{description}</div>
            <div class="flex py-2">
                <Icon name="lets-icons:date-range-fill" class="text-xl mr-2" />
                <div class="timestamp">{time}</div>
            </div>
            <div class="flex place-items-center content-center pb-2">
                <Icon name="mdi:calendar-plus" class="text-xl mr-2" />
                <a href={googleCalendarUrl} target="_blank" class="hover:text-orange-500" title="Добавить в Google Календарь">
                    Добавить в Google Календарь
                </a>
            </div>
            <div class="flex place-items-center content-center">
                {youtube &&(
                    <a class="hover:text-orange-500" href={youtube} target="_blank" title="Смотреть на YouTube">
                        <Icon name="mdi:youtube" class="text-2xl mr-2" />
                    </a>
                )}
                {twitch && (
                    <a class="hover:text-orange-500" href={twitch} target="_blank" title="Смотреть на Twitch">
                        <Icon name="mdi:twitch" class="text-2xl mr-2" />
                    </a>
                )}
            </div>
        </div>
    </div>
</div>

<script is:inline>
    var timestamps = document.getElementsByClassName("timestamp");
    var months = ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноября", "декабря"];

    for (var i = 0; i < timestamps.length; i++) {
        var dateStr = timestamps[i].innerHTML.trim();
        var t = new Date(dateStr);

        if (!isNaN(t.getTime())) {
            var day = t.getDate(),
                month = months[t.getMonth()],
                year = t.getFullYear(),
                hours = t.getHours(),
                min = t.getMinutes() + "";

            if (min.length == 1) min = "0" + min;

            if (hours === 0 && min === "01") {
                timestamps[i].innerHTML = day + " " + month + " " + year;
            } else {
                timestamps[i].innerHTML = day + " " + month + " " + year + " в " + hours + ":" + min;
            }
        } else {
            console.error("Недопустимая дата: " + dateStr);
        }
    }
</script>
